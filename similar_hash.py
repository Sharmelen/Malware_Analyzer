import os
from random import sample
import matplotlib.pyplot as plt
import matplotlib.colors as pltc
import re
import numpy as np
import tlsh
from itertools import combinations



def ssdeep():
    dir = input('File Path of Samples :')
    com_one ='ssdeep '+ dir+'* > hashes.ssd'
    com_two = 'ssdeep -m hashes.ssd '+dir+'* > result.txt'

    os.system(com_one)
    os.system(com_two)

    text = open('result.txt','r')
    whole_text = text.read()
    raw_elements = whole_text.splitlines()
    len_elements = len(whole_text.splitlines())

    for x in range (len_elements):
        try:
            if raw_elements[x] == '' :
                raw_elements.pop(x)

        except:
            print

    true_result = raw_elements

    value_1 = []
    value_2 = []
    value_3 = []

    below_11 = []
    below_21 = []
    below_31 = []
    below_41 = []
    below_51 = []
    below_61 = []
    below_71 = []
    below_81 = []
    below_91 = []
    below_101 = []

    for y in range (len(true_result)):

        phase_1 = true_result[y]
        phase_2 = phase_1.split('matches')
        value_1.append(phase_2[0].strip(dir))
        phase_3 = phase_2[1].split()
        value_2.append(phase_3[0].strip(dir))
        phase_4 = str(phase_3[1].split(' ')).strip("['()']")
        value_3.append(phase_4)



    #print(value_1[0])
    #print(value_2)
    #print(value_3)

    val = []

    for x in range (len(value_3)):
        score = int(value_3[x])
        if score < 11:
            below_11.append(score)
        if score > 10 and score < 21:
            below_21.append(score)
        if score > 20 and score < 31:
            below_31.append(score)
        if score > 30 and score < 41:
            below_41.append(score)
        if score > 40 and score < 51:
            below_51.append(score)
        if score > 50 and score < 61:
            below_61.append(score)
        if score > 60 and score < 71:
            below_71.append(score)
        if score > 70 and score < 81:
            below_81.append(score)
        if score > 80 and score < 91:
            below_91.append(score)
        if score > 90 and score < 101:
            below_101.append(score)



    all_colors = [k for k,v in pltc.cnames.items()]
    percent_score = [len(below_11),len(below_21),len(below_31),len(below_41),len(below_51),len(below_61),len(below_71),len(below_81),len(below_91),len(below_101)]
    fracs = np.array(percent_score)
    labels = ['x < 11%','10% < x < 21%','20% < x < 31%','30% < x < 41%','40% < x < 51%','50% < x < 61%','60% < x < 71%','70% < x < 81%','80% < x < 91%','90% < x < 101%']

    explode = ((fracs == max(fracs)).astype(int) / 20).tolist()

    for val in range(1):
        colors = sample(all_colors, len(fracs))
        plt.figure(figsize=(8,8))
        plt.pie(fracs, autopct='%1.1f%%',
                shadow=True, explode=explode, colors=colors)
        plt.title('Percentage of Sample Pair That Has Similar Range')
        plt.legend(labels, loc=(1.00, 0.7), shadow=True, title = 'Similarity Score Range')
        plt.show()

def tlsh_hash():
    dir = input('File Path of Samples :')
    samples = os.listdir(dir)

    comb = combinations(samples,2)
    print('-----------------------------------------')
    print('The TLSH Score For Each Pair of Samples')
    print('-----------------------------------------')
    all_score = []
    min_score = []
    med_score = []
    high_score = []
    for i in list(comb):
        full_dir = dir+i[0]
        full_dir_1 = dir+i[1]
        h1 = tlsh.hash(open(full_dir, 'rb').read())
        h2 = tlsh.hash(open(full_dir_1, 'rb').read())
        score = tlsh.diffxlen(h1, h2)
        if score < 11:
            min_score.append(score)

        elif score < 51 and score > 10:
            med_score.append(score)

        elif score < 1000 and score > 50:
            high_score.append(score)

        print(i[0]+' and '+i[1])


        print('score: '+str(score))

        all_score.append(score)
        print(':::::::::::::::::::::::::::::::::')

    all_colors = [k for k,v in pltc.cnames.items()]
    percent_score = [len(min_score),len(med_score),len(high_score)]
    fracs = np.array(percent_score)
    labels = ['< 11 (very similar)', '10 < x < 50 (somewhat similar)', 'x>50 (not similar)' ]
    explode = ((fracs == max(fracs)).astype(int) / 20).tolist()

    for val in range(1):
        colors = sample(all_colors, len(fracs))
        plt.figure(figsize=(8,8))
        plt.pie(fracs, autopct='%1.1f%%',
                shadow=True, explode=explode, colors=colors)
        plt.title('Percentage of Sample Pair That Has Similar Range')
        plt.legend(labels, loc=(1.00, 0.7), shadow=True, title = 'Similarity Score Range')
        plt.show()



#tlsh_hash()
#ssdeep()
